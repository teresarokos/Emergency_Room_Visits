---
title: "App Background Work"
author: "Teresa Rokos"
date: "11/1/2018"
output: html_document
---

```{r}
library(tidyverse)
library(readstata13)
library(knitr)
library(janitor)
library(dplyr)

emergency_visits_data <- read_rds("app_data")

glimpse(emergency_visits_data)

# Extracted clinical classification codes and corresponding conditions off MEPS website
# Copy and pasted text off of MEPS website into .txt file
# Need to separate out relevant codes so creating a dataframe (1 column) from the text file
classification_codes <- read_delim("classification_codes", delim = "\t ", col_names = FALSE)

# Filtering for rows that contain both numbers and words because those are the code/condition combos
# Separating these rows into two columns, one containing the numerical code and the other containing the condition
# In the original emergency_visits_data, there are leading zeros in the classification codes, so converting the numberical codes in both dataframes to integers so that they match (also column name for numerical codes match)
classification_codes <- classification_codes %>% 
  filter(str_detect(X1, "[abcdefghijklmnopqrstuvwxyz]"), !str_detect(X1, "Return to Top")) %>% 
  separate(X1, into = c("modified_clinical_classification_code", "condition"), sep = " ", extra = "merge") %>% 
  mutate(modified_clinical_classification_code = parse_integer(modified_clinical_classification_code),
         condition = as_factor(condition))

# Need to generate code/condition pairs for all modified_clinical_classification_code columns
classification_codes_2 <- classification_codes %>% 
  mutate(modified_clinical_classification_code_2 = modified_clinical_classification_code,
         condition_2 = condition) %>% 
  select(modified_clinical_classification_code_2, condition_2)

classification_codes_3 <- classification_codes %>% 
  mutate(modified_clinical_classification_code_3 = modified_clinical_classification_code,
         condition_3 = condition) %>% 
  select(modified_clinical_classification_code_3, condition_3)

classification_codes_4 <- classification_codes %>% 
  mutate(modified_clinical_classification_code_4 = modified_clinical_classification_code,
         condition_4 = condition) %>% 
  select(modified_clinical_classification_code_4, condition_4)

# Joining classification codes to emergency visits data
emergency_visits_data <- emergency_visits_data %>% 
  mutate(modified_clinical_classification_code = parse_integer(modified_clinical_classification_code),
         modified_clinical_classification_code_2 = parse_integer(modified_clinical_classification_code_2),
         modified_clinical_classification_code_3 = parse_integer(modified_clinical_classification_code_3),
         modified_clinical_classification_code_4 = parse_integer(modified_clinical_classification_code_4)) %>%
  left_join(classification_codes, by = "modified_clinical_classification_code") %>% 
  left_join(classification_codes_2, by = "modified_clinical_classification_code_2") %>%
  left_join(classification_codes_3, by = "modified_clinical_classification_code_3") %>%
  left_join(classification_codes_4, by = "modified_clinical_classification_code_4")

# Cleaning up some of the variable names surrounding services
emergency_visits_data <- emergency_visits_data %>% 
  rename(`Category of Care` = best_category_for_care_p_recv_on_vst_dt, 
            `Specific Condition` = this_vst_related_to_spec_condition,
            `Lab Tests` = this_visit_did_p_have_lab_tests,
            `Sonogram or Ultrasound` = this_visit_did_p_have_sonogram_or_ultrsd,
            `X-Rays` = this_visit_did_p_have_x_rays,
            `Mammogram` = this_visit_did_p_have_a_mammogram,
            `MRI or CT Scan` = this_visit_did_p_have_an_mri_catscan,
            `EKG or ECG` = this_visit_did_p_have_an_ekg_or_ecg,
            `EEG` = this_visit_did_p_have_an_eeg,
            `Vaccination` = this_visit_did_p_receive_a_vaccination,
            `Anesthesia` = this_visit_did_p_receive_anesthesia,
            `Throat Swab` = this_visit_did_p_have_a_throat_swab,
            `Other Diagnostic Test/Exam` = this_visit_did_p_have_oth_diag_test_exam,
            `Surgery` =  was_surg_proc_performed_on_p_this_visit,
            `Medicine Prescribed` = any_medicine_prescribed_for_p_this_visit,
            `Total Expenditure` = tot_exp_for_event_erfxp16x_erdxp16x,
            `Total Charge` = total_chg_for_event_erftc16x_erdtc16x) %>% 
  mutate(`Total Expenditure` = `Total Expenditure` + 1)

# Writing this file to my app folder
emergency_visits_data %>% 
  write_rds("App/app_data")

# table providing the number of times each service was provided
aggregate_services <- emergency_visits_data %>% 
  filter(`Lab Tests` == "1 YES") %>% 
  summarize(service = "Lab Tests", n_visits = n())

aggregate_services <- emergency_visits_data %>% 
  filter(`Sonogram or Ultrasound` == "1 YES") %>% 
  summarize(service = "Sonogram or Ultrasound", n_visits = n()) %>% 
  bind_rows(aggregate_services)

aggregate_services <- emergency_visits_data %>% 
  filter(`X-Rays` == "1 YES") %>% 
  summarize(service = "X-Rays", n_visits = n()) %>% 
  bind_rows(aggregate_services)

aggregate_services <- emergency_visits_data %>% 
  filter(Mammogram == "1 YES") %>% 
  summarize(service = "Mammogram", n_visits = n()) %>% 
  bind_rows(aggregate_services)

aggregate_services <- emergency_visits_data %>% 
  filter(`MRI or CT Scan` == "1 YES") %>% 
  summarize(service = "MRI or CT Scan", n_visits = n()) %>% 
  bind_rows(aggregate_services)

aggregate_services <- emergency_visits_data %>% 
  filter(`EKG or ECG` == "1 YES") %>% 
  summarize(service = "EKG or ECG", n_visits = n()) %>% 
  bind_rows(aggregate_services)

aggregate_services <- emergency_visits_data %>% 
  filter(`EEG` == "1 YES") %>% 
  summarize(service = "EEG", n_visits = n()) %>% 
  bind_rows(aggregate_services)

aggregate_services <- emergency_visits_data %>% 
  filter(Vaccination == "1 YES") %>% 
  summarize(service = "Vaccination", n_visits = n()) %>% 
  bind_rows(aggregate_services)

aggregate_services <- emergency_visits_data %>% 
  filter(Anesthesia == "1 YES") %>% 
  summarize(service = "Anesthesia", n_visits = n()) %>% 
  bind_rows(aggregate_services)

aggregate_services <- emergency_visits_data %>% 
  filter(`Throat Swab` == "1 YES") %>% 
  summarize(service = "Throat Swab", n_visits = n()) %>% 
  bind_rows(aggregate_services)

aggregate_services <- emergency_visits_data %>% 
  filter(`Other Diagnostic Test/Exam` == "1 YES") %>% 
  summarize(service = "Other Diagnostic Test/Exam", n_visits = n()) %>% 
  bind_rows(aggregate_services)

aggregate_services <- emergency_visits_data %>% 
  filter(Surgery == "1 YES") %>% 
  summarize(service = "Surgery", n_visits = n()) %>% 
  bind_rows(aggregate_services)

aggregate_services <- emergency_visits_data %>% 
  filter(`Medicine Prescribed` == "1 YES") %>% 
  summarize(service = "Medicine Prescribed", n_visits = n()) %>% 
  bind_rows(aggregate_services)
```

```{r}
# Generating a bar plot that shows the most popular services provided
aggregate_services %>% 
  ggplot(aes(x = fct_reorder(service, n_visits), y = n_visits)) +
  geom_col() +
  coord_flip() +
  scale_x_discrete(name = "") +
  ylab("Number of visits that provided service") +
  ggtitle("Most Popular Emergency Room Services")

emergency_visits_data %>% 
  select(person_id_duid_pid, `Lab Tests`, `Sonogram or Ultrasound`, `X-Rays`, Mammogram, 
         `MRI or CT Scan`, `EKG or ECG`, EEG, Vaccination, Anesthesia, `Throat Swab`, 
         `Other Diagnostic Test/Exam`, Surgery, `Medicine Prescribed`, `Total Expenditure`, 
         condition, condition_2, condition_3, condition_4, `Total Charge`) %>% 
  gather(key = "service", value = "provided", -`Total Expenditure`, -person_id_duid_pid, 
         -condition, -condition_2, -condition_3, -condition_4) %>% 
  arrange(person_id_duid_pid) %>%
  filter(provided == "1 YES") %>% 
  ggplot(aes(x = service, y = `Total Expenditure`, color = service)) +
  geom_boxplot(show.legend = FALSE) +
  scale_y_continuous(name = "Total Expenditure on Event", trans = "log10", 
                     breaks = c(100, 500, 1000, 5000, 10000, 50000, 100000),
                     labels = c("$100", "$500", "$1,000", "$5,000", "$10,000", "$50,000", "$100,000")) +
  xlab("") +
  scale_color_manual(values = c("Lab Tests" = "#F8766D", "X-Rays" = "#24B700", "Medicine Prescribed" = "#00ACFC", 
                       "MRI or CT Scan" = "#FF65AC", "EKG or ECG" = "#E18A00", 
                       "Other Diagnostic Test/Exam" = "#00BE70", "Sonogram or Ultrasound" = "#8B93FF",
                       "Surgery" = "#BE9C00", "Anesthesia" = "#00C1AB", "Throat Swab" = "#D575FE",
                       "EEG" = "#8CAB00", "Vaccination" = "#00BBDA", "Mammogram" = "#F962DD")) +
  coord_flip()

# Figuring out which colors are the default colors used by ggplot
library(scales)
  show_col(hue_pal()(13))
  
```

```{r patients page}
emergency_visits_data %>% 
  count(dwelling_unit_id) %>% 
  arrange(desc(n))

emergency_visits_data %>% 
  count(person_id_duid_pid) %>% 
  arrange(desc(n))

emergency_visits_data %>% 
  count(event_id_for_corresponding_hospital_stay) %>% 
  arrange(desc(n))

emergency_visits_data %>% 
  group_by(dwelling_unit_id) %>% 
  mutate(household_visits = n(), total_16_cost = sum(`Total Expenditure`)) %>% 
  ungroup() %>% 
  ggplot(aes(x = household_visits, y = total_16_cost)) +
  geom_jitter()

emergency_visits_data %>% 
  filter(event_date_month != -9) %>% 
  group_by(event_date_year) %>% 
  mutate(average_expenditure = sum(`Total Expenditure`)/n()) %>% 
  ungroup() %>% 
  ggplot(aes(x = event_date_month, y = average_expenditure)) +
  geom_jitter()
```

